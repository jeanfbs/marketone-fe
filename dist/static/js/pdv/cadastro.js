define(["ajax","keyevent","api"],function(n,s,i){var r=function(t){var e={};return e.response=t,e.quantidade=t.quantidade,e.totalItem=parseFloat(t.valorUnitario)*t.quantidade,e.response.valorUnitario=isNaN(e.response.valorUnitario)?0:e.response.valorUnitario,$("#descricao").text(t.descricao),$("#medida").text(t.medida),$("#spanCodigoBarra").text(t.codigoBarra),$("#spanValorUnitario").text(t.valorUnitario.toLocaleString()),$("#spanQuantidade").text(t.quantidade),$("#spanTotalItem").text(e.totalItem.toLocaleString()),e},a={selector:$("#modalRemoveItemByIndex"),show:function(){this.selector.modal("show")},hide:function(){this.selector.modal("hide")},listenEvent:function(){var e=this;$("#btnRemoveItem").on("click",function(){e.confirmed()}),$("#numeroItem").on("keydown",function(t){t.which==s.Shorcut.ENTER&&e.confirmed()})},confirmed:function(){var t=$("#numeroItem"),e=t.val();l.removeItem(e),this.selector.modal("hide"),t.val("")}},d=function(){function t(t,e){this.name=t,this.button=t+"BtnAccept",o(t,this.button)}var o=function(t,e){var o='<div class="modal fade" tabindex="-1" role="dialog" id="'+t+'" aria-labelledby="alertModal">        <div class="modal-dialog modal-md" role="document">            <div class="modal-content">                <div class="modal-header">                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">                        <span aria-hidden="true">×</span>                    </button>                    <h4 class="modal-title text-primary" id="alertModal">Confirmação de exclusão de item na compra</h4>                </div>                <div class="modal-body">                    <p class="text-justify message">                    </p>                </div>                <div class="modal-footer">                    <button type="button" class="btn btn-default" data-dismiss="modal">Não</button>                    <button type="button" class="btn btn-primary"  id="'+e+'">Sim</button>                </div>            </div>        </div>    </div>';$("#content").append(o)};return t.prototype.listenAccept=function(e){$("#"+this.button).on("click",function(){e()}),$("#"+this.name).on("keydown",function(t){t.which==s.Shorcut.ENTER&&e()})},t.prototype.show=function(t){$("#itens tbody tr").length;$("#"+this.name).find(".message").text(t),$("#"+this.name).modal("show")},t.prototype.hide=function(){$("#"+this.name).modal("hide")},t}(),l={addItemToTable:function(t){var e=$.Deferred(),o=parseInt($("#itens tbody tr").length)+1,a="<tr data-item="+btoa(JSON.stringify(t))+'><td class="text-center">'+o+"</td><td>"+t.response.codigoBarra+'</td><td class="col-sm-6">'+this.formatDescription(t.response.descricao,t.quantidade,t.response.medida)+"</td><td>R$ "+t.response.valorUnitario.toLocaleString()+"</td><td>R$ "+t.totalItem.toLocaleString()+"</td></tr>";$("#itens").append(a);var n=parseInt($("#itens tbody").height());return $(".dataTables_scrollBody").scrollTop(n),e.resolve(),e},removeItem:function(t){if(t--,0==$("#itens tbody tr").length)return $("#messageAlert").removeClass("hide"),setTimeout(function(){$("#messageAlert").addClass("hide")},5e3),!1;$("#itens tbody tr:eq("+t+")").remove(),l.calculaValorCompra(),l.reindexItens(),l.setTotalItens()},formatDescription:function(t,e,o){return t+"&emsp;&emsp;&emsp;&emsp;"+e+" x "+o},calculaValorCompra:function(){var a=0;$("#itens tbody tr").each(function(t,e){var o=JSON.parse(atob($(e).attr("data-item")));a+=o.totalItem}),$("#spanValorTotal").text(a.toLocaleString())},reindexItens:function(){var o=1;$("#itens tbody tr").each(function(t,e){$(e).children("td:eq(0)").text(o),o++})},setTotalItens:function(){$(".dataTables_scrollFootInner").find("td[colspan=2]").text(parseInt($("#itens tbody tr").length))}};$(function(){$("#insertHeader").load("../../fragmentos/menu-navegacao.html"),$("#navbar-theme").addClass("hide");$("#itens").DataTable({paging:!1,ordering:!1,info:!1,searching:!1,scrollY:"175px",scrollCollapse:!0});$("#itens tbody").empty(),$("#hideMenu").on("click",function(){$(this).hasClass("selected")?($(this).removeClass("selected"),$("#navbar-theme").removeClass("hide")):($(this).addClass("selected"),$("#navbar-theme").addClass("hide"))});var t=new s.Registry;t.add(s.Shorcut.F6,function(){$("#buscaProduto").focus().select()}),t.add(s.Shorcut.F7,function(){var t=$("#dadosProduto"),e=$("#pagamento");t.hasClass("hide")?(t.removeClass("hide"),e.addClass("hide"),$("#buscaProduto").prop("disabled",!1)):(t.addClass("hide"),e.removeClass("hide"),$("#cliente").focus(),$("#buscaProduto").prop("disabled",!0))});var e=new d("removeIndexModal");e.listenAccept(function(){e.hide();var t=$("#itens tbody tr").length;l.removeItem(t)}),t.add(s.Shorcut.F8,function(){var t=$("#itens tbody tr").length;e.show("Você irá remover o item "+t+" da compra, deseja prosseguir?")}),a.listenEvent(),t.add(s.Shorcut.F9,function(){a.show()}),$("#modalRemoveItemByIndex").on("shown.bs.modal",function(){$("#numeroItem").focus()});var o=new d("cancelItemsModal");o.listenAccept(function(){$("#itens tbody").empty(),l.calculaValorCompra(),l.setTotalItens(),o.hide()}),t.add(s.Shorcut.F10,function(){o.show("Você irá cancelar todos os itens da compra, deseja prosseguir?")}),$("#buscaProduto").on("keyup",function(t){if(t.keyCode==s.Shorcut.ENTER){var e=$(this).val(),o=0,a=1;1==e.indexOf("*")?(o=parseInt(e.split("*")[1]),a=parseInt(e.split("*")[0])):o=parseInt(e),new n.WebClient(i["pdv.pesquisa.produto"]+"?codigoBarra="+o,"GET").call().done(function(t){t[0].quantidade=a;var e=r(t[0]);$.when(l.addItemToTable(e)).then(l.calculaValorCompra()),l.setTotalItens()}).fail(function(t){alert("erro")})}}),BuscaCliente={formatItem:function(t){return t.loading?t.text:t.nome},formatItemSelection:function(t){return $("#codigoCliente").val(t.cpfCnpj),t.nome||t.text}},$("#cliente").select2({theme:"bootstrap",ajax:{url:i["pdv.pesquisa.cliente"],dataType:"json",data:function(t){return{value:t.term}},processResults:function(t,e){return{results:$.map(t,function(t){return t.id=t.cpfCnpj,t.text=t.nome,t})}},cache:!1},placeholder:"Buscar Clientes",escapeMarkup:function(t){return t},minimumInputLength:1,templateResult:BuscaCliente.formatItem,templateSelection:BuscaCliente.formatItemSelection})})});