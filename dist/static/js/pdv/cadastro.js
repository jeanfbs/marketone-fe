define(["ajax","keyevent","api"],function(n,r,i){var s=function(t){var e={};return e.response=t,e.quantidade=t.quantidade,e.totalItem=parseFloat(t.valorUnitario)*t.quantidade,e.response.valorUnitario=isNaN(e.response.valorUnitario)?0:e.response.valorUnitario,$("#descricao").text(t.descricao),$("#medida").text(t.medida),$("#spanCodigoBarra").text(t.codigoBarra),$("#spanValorUnitario").text(t.valorUnitario.toLocaleString()),$("#spanQuantidade").text(t.quantidade),$("#spanTotalItem").text(e.totalItem.toLocaleString()),e},o={selector:$("#modalRemoveItemByIndex"),show:function(){$("#numeroItem").empty(),$("#itens tbody tr").each(function(t,e){$("#numeroItem").append($("<option></option>").val(t).text(t+1))}),this.selector.modal("show")},hide:function(){this.selector.modal("hide")},listenEvent:function(){var e=this;$("#btnRemoveItem").on("click",function(){e.confirmed()}),$("#numeroItem").on("keydown",function(t){t.which==r.Shorcut.S&&e.confirmed()})},confirmed:function(){var t=$("#numeroItem"),e=t.find("option:selected").val();l.removeItem(e),this.selector.modal("hide"),t.val("")}},d=function(){function t(t,e){this.name=t,this.button=t+"BtnAccept",a(t,this.button)}var a=function(t,e){var a='<div class="modal fade" tabindex="-1" role="dialog" id="'+t+'" aria-labelledby="alertModal">        <div class="modal-dialog modal-md" role="document">            <div class="modal-content">                <div class="modal-header">                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">                        <span aria-hidden="true">×</span>                    </button>                    <h4 class="modal-title text-primary" id="alertModal">Confirmação de exclusão de item na compra</h4>                </div>                <div class="modal-body">                    <p class="text-justify message">                    </p>                </div>                <div class="modal-footer">                    <button type="button" class="btn btn-default" data-dismiss="modal">Não</button>                    <button type="button" class="btn btn-primary"  id="'+e+'">Sim</button>                </div>            </div>        </div>    </div>';$("#content").append(a)};return t.prototype.listenAccept=function(e){$("#"+this.button).on("click",function(){e()}),$("#"+this.name).on("keydown",function(t){t.which==r.Shorcut.ENTER&&e()})},t.prototype.show=function(t){$("#itens tbody tr").length;$("#"+this.name).find(".message").text(t),$("#"+this.name).modal("show")},t.prototype.hide=function(){$("#"+this.name).modal("hide")},t}(),l={addItemToTable:function(t){var e=$.Deferred(),a=parseInt($("#itens tbody tr").length)+1,o="<tr data-item="+btoa(JSON.stringify(t))+'><td class="text-center">'+a+"</td><td>"+t.response.codigoBarra+'</td><td class="col-sm-6">'+this.formatDescription(t.response.descricao,t.quantidade,t.response.medida)+"</td><td>R$ "+t.response.valorUnitario.toLocaleString()+"</td><td>R$ "+t.totalItem.toLocaleString()+"</td></tr>";$("#itens").append(o);var n=parseInt($("#itens tbody").height());return $(".dataTables_scrollBody").scrollTop(n),e.resolve(),e},removeItem:function(t){if(0==$("#itens tbody tr").length)return c.print("Não há itens para serem excluidos"),!1;$("#itens tbody tr:eq("+t+")").remove(),l.calculaValorCompra(),l.reindexItens(),l.setTotalItens()},formatDescription:function(t,e,a){return t+"&emsp;&emsp;&emsp;&emsp;"+e+" x "+a},calculaValorCompra:function(){var o=0;$("#itens tbody tr").each(function(t,e){var a=JSON.parse(atob($(e).attr("data-item")));o+=a.totalItem}),$("#spanValorTotal").text(o.toLocaleString()).attr("data-total-compra",o)},reindexItens:function(){var a=1;$("#itens tbody tr").each(function(t,e){$(e).children("td:eq(0)").text(a),a++})},setTotalItens:function(){$(".dataTables_scrollFootInner").find("td[colspan=2]").text(parseInt($("#itens tbody tr").length))}},c={print:function(t){var e=$("#alert");e.find("#alertMessage").text(t),e.removeClass("hide"),setTimeout(function(){e.addClass("hide")},5e3)}},u={formatItem:function(t){return t.loading?t.text:t.nome},formatItemSelection:function(t){return $("#codigoCliente").val(t.cpfCnpj),t.nome||t.text}},m=function(){var a=0;$(".cash").each(function(t,e){a+=isNaN($(this).val())||""==$(this).val()?0:parseFloat($(this).val())});var t=parseFloat($("#spanValorTotal").attr("data-total-compra")),e=a-t;$("#spanValorRecebido").text(a.toLocaleString()).attr("data-valor-recebido",a),$("#spanValorTroco").text(e.toLocaleString()).attr("data-valor-troco",e)},p=function(){return"true"===$("#pagamento").attr("data-ativo")};$(function(){$("#insertHeader").load("../../fragmentos/menu-navegacao.html"),$("#navbar-theme").addClass("hide");$("#itens").DataTable({paging:!1,ordering:!1,info:!1,searching:!1,scrollY:"175px",scrollCollapse:!0});$("#itens tbody").empty(),$("#hideMenu").on("click",function(){$(this).hasClass("selected")?($(this).removeClass("selected"),$("#navbar-theme").removeClass("hide")):($(this).addClass("selected"),$("#navbar-theme").addClass("hide"))});var t=new r.Registry;t.add(r.Shorcut.F2,function(){$("#buscaProduto").focus().select()}),t.add(r.Shorcut.F6,function(){alert("FInalizar Compra?")}),t.add(r.Shorcut.F7,function(){var t=$("#dadosProduto"),e=$("#pagamento");t.hasClass("hide")?(t.removeClass("hide"),e.addClass("hide").attr("data-ativo",!1),$("#buscaProduto").prop("disabled",!1)):(t.addClass("hide"),e.removeClass("hide").attr("data-ativo",!0),$("#cliente").focus(),$("#buscaProduto").prop("disabled",!0))});var e=new d("removeIndexModal");e.listenAccept(function(){e.hide();var t=$("#itens tbody tr").length;l.removeItem(t)}),t.add(r.Shorcut.F8,function(){if(p())return c.print("Não é possivel remover itens durante o processo de pagamento."),!1;var t=$("#itens tbody tr").length;e.show("Você irá remover o item "+t+" da compra, deseja prosseguir?")}),o.listenEvent(),t.add(r.Shorcut.F9,function(){if(p())return c.print("Não é possivel remover itens durante o processo de pagamento."),!1;o.show()}),$("#modalRemoveItemByIndex").on("shown.bs.modal",function(){$("#numeroItem").focus()});var a=new d("cancelItemsModal");a.listenAccept(function(){$("#itens tbody").empty(),l.calculaValorCompra(),l.setTotalItens(),$("#pagamento input").each(function(){$(this).val("")}),$("#spanValorRecebido").text(0).attr("data-valor-recebido",0),$("#spanValorTroco").text(0).attr("data-valor-troco",0),$("#dadosProduto").removeClass("hide"),$("#pagamento").addClass("hide"),$("#buscaProduto").prop("disabled",!1),a.hide()}),t.add(r.Shorcut.F10,function(){a.show("Você irá cancelar todos os itens da compra, deseja prosseguir?")}),$("#buscaProduto").on("keyup",function(t){if(t.keyCode==r.Shorcut.ENTER){var e=$(this).val(),a=0,o=1;1==e.indexOf("*")?(a=parseInt(e.split("*")[1]),o=parseInt(e.split("*")[0])):a=parseInt(e),new n.WebClient(i["pdv.pesquisa.produto"]+"?codigoBarra="+a,"GET").call().done(function(t){t[0].quantidade=o;var e=s(t[0]);$.when(l.addItemToTable(e)).then(l.calculaValorCompra()),l.setTotalItens()}).fail(function(t){alert("erro")})}}),$("#cliente").select2({theme:"bootstrap",ajax:{url:i["pdv.pesquisa.cliente"],dataType:"json",data:function(t){return{value:t.term}},processResults:function(t,e){return{results:$.map(t,function(t){return t.id=t.cpfCnpj,t.text=t.nome,t})}},cache:!1},placeholder:"Buscar Clientes",escapeMarkup:function(t){return t},minimumInputLength:1,templateResult:u.formatItem,templateSelection:u.formatItemSelection}),$(".cash").focusout(function(){m()})})});