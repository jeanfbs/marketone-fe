define(["ajax","keyevent","api"],function(r,n,i){var s={minimumFractionDigits:2,style:"currency",currency:"BRL"},l=function(t){var a={};return a.response=t,a.quantidade=t.quantidade,a.totalItem=parseFloat(t.valorUnitario)*t.quantidade,a.response.valorUnitario=isNaN(a.response.valorUnitario)?0:a.response.valorUnitario,$("#descricao").text(t.descricao),$("#medida").text(t.medida),$("#spanCodigoBarra").text(t.codigoBarra),$("#spanValorUnitario").text(t.valorUnitario.toLocaleString("pt-BR",s)),$("#spanQuantidade").text(t.quantidade),$("#spanTotalItem").text(a.totalItem.toLocaleString("pt-BR",s)),a},o={selector:$("#modalRemoveItemByIndex"),show:function(){$("#numeroItem").empty(),$("#itens tbody tr").each(function(t,a){$("#numeroItem").append($("<option></option>").val(t).text(t+1))}),this.selector.modal("show")},hide:function(){this.selector.modal("hide")},listenEvent:function(){var a=this;$("#btnRemoveItem").on("click",function(){a.confirmed()}),$("#numeroItem").on("keydown",function(t){t.which==n.Shorcut.S&&a.confirmed()})},confirmed:function(){var t=$("#numeroItem"),a=t.find("option:selected").val();c.removeItem(a),this.selector.modal("hide"),t.val("")}},d=function(){function t(t,a){var e,o,r;this.name=t,this.button=t+"BtnAccept",e=t,o=this.button,r='<div class="modal fade" tabindex="-1" role="dialog" id="'+e+'" aria-labelledby="alertModal">        <div class="modal-dialog modal-md" role="document">            <div class="modal-content">                <div class="modal-header">                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">                        <span aria-hidden="true">×</span>                    </button>                    <h4 class="modal-title text-primary" id="alertModal">Confirmação de exclusão de item na compra</h4>                </div>                <div class="modal-body">                    <p class="text-justify message">                    </p>                </div>                <div class="modal-footer">                    <button type="button" class="btn btn-default" data-dismiss="modal">Não</button>                    <button type="button" class="btn btn-primary"  id="'+o+'">Sim</button>                </div>            </div>        </div>    </div>',$("#content").append(r)}return t.prototype.listenAccept=function(a){$("#"+this.button).on("click",function(){a()}),$("#"+this.name).on("keydown",function(t){t.which==n.Shorcut.ENTER&&a()})},t.prototype.show=function(t){$("#itens tbody tr").length;$("#"+this.name).find(".message").text(t),$("#"+this.name).modal("show")},t.prototype.hide=function(){$("#"+this.name).modal("hide")},t}(),c={addItemToTable:function(t){var a=$.Deferred(),e=parseInt($("#itens tbody tr").length)+1,o="<tr data-item="+btoa(JSON.stringify(t))+'><td class="text-center">'+e+"</td><td>"+t.response.codigoBarra+'</td><td class="col-sm-6">'+this.formatDescription(t.response.descricao,t.quantidade,t.response.medida)+"</td><td>"+t.response.valorUnitario.toLocaleString("pt-BR",s)+"</td><td>"+t.totalItem.toLocaleString("pt-BR",s)+"</td></tr>";$("#itens").append(o);var r=parseInt($("#itens tbody").height());return $(".dataTables_scrollBody").scrollTop(r),a.resolve(),a},removeItem:function(t){if(0==$("#itens tbody tr").length)return p.print("Não há itens para serem excluidos"),!1;$("#itens tbody tr:eq("+t+")").remove(),c.calculaValorCompra(),c.reindexItens(),c.setTotalItens()},formatDescription:function(t,a,e){return t+"&emsp;&emsp;&emsp;&emsp;"+a+" x "+e},calculaValorCompra:function(){var o=0;$("#itens tbody tr").each(function(t,a){var e=JSON.parse(atob($(a).attr("data-item")));o+=e.totalItem}),$("#spanValorTotal").text(o.toLocaleString("pt-BR",s)).attr("data-valor-total",o)},getItens:function(){var o=[];return $("#itens tbody tr").each(function(t,a){var e=JSON.parse(atob($(a).attr("data-item")));o.push(e)}),o},reindexItens:function(){var e=1;$("#itens tbody tr").each(function(t,a){$(a).children("td:eq(0)").text(e),e++})},setTotalItens:function(){$(".dataTables_scrollFootInner").find("td[colspan=2]").text(parseInt($("#itens tbody tr").length))}},p={print:function(t){var a=$("#alert");a.find("#alertMessage").text(t),a.removeClass("hide"),setTimeout(function(){a.addClass("hide")},5e3)}},u={formatItem:function(t){return t.loading?t.text:t.nome},formatItemSelection:function(t){return $("#codigoCliente").val(t.cpfCnpj),t.nome||t.text}},m={calculaValorTroco:function(){var e=0;$(".cash").each(function(t,a){e+=isNaN($(this).val())||""==$(this).val()?0:parseFloat($(this).val())});var t=parseFloat($("#spanValorTotal").attr("data-valor-total")),a=0;if(""!=$("#valorDeconto").val()?a=parseFloat($("#valorDeconto").val()):""!=$("#taxaDesconto").val()&&(a=parseFloat($("#taxaDesconto").val())/100*t),(t-=a)<0)return m.Erro.print("O valor de desconto ultrapassou o valor total da compra."),m.invalidar(),!1;m.Erro.clear(),m.validar(),$("#spanValorTotal").text(t.toLocaleString("pt-BR",s)).attr("data-valor-desconto",a);var o=e-t,r=$("#spanValorRecebido"),n=$("#spanValorTroco");o<0?(this.Erro.print("O valor recebido não é suficiente para completar o pagamento."),o=e=0,this.invalidar()):(this.Erro.clear(),this.validar()),r.text(e.toLocaleString("pt-BR",s)).attr("data-valor-recebido",e),n.text(o.toLocaleString("pt-BR",s)).attr("data-valor-troco",o)},estaAtivo:function(){return"true"===$("#pagamento").attr("data-ativo")},estaValido:function(){return"true"===$("#pagamentoForm").attr("data-valid")},invalidar:function(){$("#pagamentoForm").attr("data-valid",!1)},validar:function(){$("#pagamentoForm").attr("data-valid",!0)},trocaPagamentoDiv:function(t){var a=$("#dadosProduto"),e=$("#pagamento"),o=$("#buscaProduto");a.hasClass("hide")?(a.removeClass("hide"),e.addClass("hide").attr("data-ativo",!1),o.prop("disabled",!1)):(a.addClass("hide"),e.removeClass("hide").attr("data-ativo",!0),$("#cliente").focus(),o.prop("disabled",!0))},setValoresCompra:function(t){var a=$("#spanValorTotal");""==a.attr("data-valor-total")||isNaN(parseFloat(a.attr("data-valor-total")))||(t.valorTotal=parseFloat(a.attr("data-valor-total")),""==a.attr("data-valor-desconto")||isNaN(parseFloat(a.attr("data-valor-desconto")))||(t.desconto=parseFloat(a.attr("data-valor-desconto"))));var e=$("#spanValorRecebido");""==e.attr("data-valor-recebido")||isNaN(parseFloat(e.attr("data-valor-recebido")))||(t.valorRecebido=parseFloat(e.attr("data-valor-recebido")));var o=$("#spanValorTroco");""==o.attr("data-valor-troco")||isNaN(parseFloat(o.attr("data-valor-troco")))||(t.valorTroco=parseFloat(o.attr("data-valor-troco")))},setValoresPagamento:function(t){var a=$("#dinheiro");""==a.val()||isNaN(parseFloat(a.val()))||(t.pagamento.dinheiro=parseFloat(a.val()));var e=$("#cartaoDebito");""==e.val()||isNaN(parseFloat(e.val()))||(t.pagamento.debito=parseFloat(e.val()));var o=$("#cartaoCredito");""==o.val()||isNaN(parseFloat(o.val()))||(t.pagamento.credito=parseFloat(o.val()))},setItensCompra:function(t){t.itens=c.getItens()},Erro:{print:function(t){$("#erroPagamentoMessage").text(t),$("#erroPagamento").removeClass("hide")},clear:function(){$("#erroPagamentoMessage").text(""),$("#erroPagamento").addClass("hide")}}},v=function(){$("#itens tbody").empty(),$("#pagamentoForm input").each(function(){$(this).val("")}),$("#cliente").val(null).trigger("change"),$("#descricao").text("CAIXA LIVRE");var t=[$("#medida"),$("#spanCodigoBarra"),$("#spanValorUnitario"),$("#spanQuantidade"),$("#spanTotalItem"),$("#spanValorTotal"),$("#spanValorRecebido"),$("#spanValorTroco")];$.each(t,function(t,a){$(this).text("")})},h={init:function(){return setInterval(this.addProgress,150)},addProgress:function(){var t=$(".progress-bar"),a=t.width()+50;t.width(a)},stopProgress:function(t){clearInterval(t),$(".progress-bar").width(1)}};$(function(){$("#insertHeader").load("../../fragmentos/menu-navegacao.html"),$("#navbar-theme").addClass("hide");$("#itens").DataTable({paging:!1,ordering:!1,info:!1,searching:!1,scrollY:"175px",scrollCollapse:!0});$("#itens tbody").empty(),$("#hideMenu").on("click",function(){var t=$(this).hasClass("selected"),a=$("#navbar-theme");t?($(this).removeClass("selected"),a.removeClass("hide")):($(this).addClass("selected"),a.addClass("hide"))});var t=new n.Registry;t.add(n.Shorcut.F2,function(){$("#buscaProduto").focus().select()}),t.add(n.Shorcut.F6,function(){if(!m.estaValido())return p.print("Os dados do pagamento estão inválidos."),!1;var t=$("#progressoFecharCompra").modal("show"),a={};m.setValoresCompra(a),a.pagamento={},m.setValoresPagamento(a),a.itens={},m.setItensCompra(a);var e=h.init();setTimeout(function(){$.when(h.stopProgress(e)).then(function(){t.modal("hide"),m.trocaPagamentoDiv(!1),v()})},2e3),a.caixa=parseInt($("#caixa").attr("data-id-caixa")),a.timestamp=(new Date).getTime()}),t.add(n.Shorcut.F7,function(){if(0==c.getItens().length)return p.print("Nenhum item foi adicionado na compra."),!1;m.trocaPagamentoDiv(!$("#dadosProduto").hasClass("hide"))});var a=new d("removeIndexModal");a.listenAccept(function(){var t=$("#itens tbody tr").length-1;c.removeItem(t),a.hide()}),t.add(n.Shorcut.F8,function(){if(m.estaAtivo())return p.print("Não é possivel remover itens durante o processo de pagamento."),!1;var t=$("#itens tbody tr").length;a.show("Você irá remover o item "+t+" da compra, deseja prosseguir?")}),o.listenEvent(),t.add(n.Shorcut.F9,function(){if(m.estaAtivo())return p.print("Não é possivel remover itens durante o processo de pagamento."),!1;o.show()}),$("#modalRemoveItemByIndex").on("shown.bs.modal",function(){$("#numeroItem").focus()});var e=new d("cancelItemsModal");e.listenAccept(function(){$("#itens tbody").empty(),c.calculaValorCompra(),c.setTotalItens(),$("#pagamento input").each(function(){$(this).val("")}),$("#spanValorRecebido").text(0).attr("data-valor-recebido",0),$("#spanValorTroco").text(0).attr("data-valor-troco",0),$("#dadosProduto").removeClass("hide"),$("#pagamento").addClass("hide"),$("#buscaProduto").prop("disabled",!1),e.hide()}),t.add(n.Shorcut.F10,function(){if(0==c.getItens().length)return p.print("Nenhum item foi adicionado na compra."),!1;e.show("Você irá cancelar todos os itens da compra, deseja prosseguir?")}),$("#buscaProduto").on("keyup",function(t){if(t.keyCode==n.Shorcut.ENTER){var a=$(this).val(),e=0,o=1;1==a.indexOf("*")?(e=parseInt(a.split("*")[1]),o=parseInt(a.split("*")[0])):e=parseInt(a),new r.WebClient(i["pdv.pesquisa.produto"]+"?codigoBarra="+e,"GET").call().done(function(t){t[0].quantidade=o;var a=l(t[0]);$.when(c.addItemToTable(a)).then(c.calculaValorCompra()),c.setTotalItens()}).fail(function(t){alert("erro")})}}),$("#cliente").select2({theme:"bootstrap",allowClear:!0,ajax:{url:i["pdv.pesquisa.cliente"],dataType:"json",data:function(t){return{value:t.term}},processResults:function(t,a){return{results:$.map(t,function(t){return t.id=t.cpfCnpj,t.text=t.nome,t})}},cache:!1},placeholder:"Buscar Clientes",escapeMarkup:function(t){return t},minimumInputLength:1,templateResult:u.formatItem,templateSelection:u.formatItemSelection}),$(".cash").on("keyup change",function(){m.calculaValorTroco()}),$(".desconto").on("keyup change",function(){var t=$(this).attr("id");$(".desconto").prop("disabled",!1),""!=$(this).val()&&("valorDeconto"==t?$("#taxaDesconto").prop("disabled",!0):$("#valorDeconto").prop("disabled",!0)),m.calculaValorTroco()})})});