define(["ajax","keyevent","api"],function(n,r,s){var i=function(e){var t={};return t.response=e,t.quantidade=e.quantidade,t.totalItem=parseFloat(e.valorUnitario)*e.quantidade,t.response.valorUnitario=isNaN(t.response.valorUnitario)?0:t.response.valorUnitario,$("#descricao").text(e.descricao),$("#medida").text(e.medida),$("#spanCodigoBarra").text(e.codigoBarra),$("#spanValorUnitario").text(e.valorUnitario.toLocaleString()),$("#spanQuantidade").text(e.quantidade),$("#spanTotalItem").text(t.totalItem.toLocaleString()),t},t={selector:$("#modalRemoveItemByIndex"),show:function(){this.selector.modal("show")},hide:function(){this.selector.modal("hide")},listenEvent:function(){var t=this;$("#btnRemoveItem").on("click",function(){t.confirmed()}),$("#numeroItem").on("keydown",function(e){e.which==r.Shorcut.ENTER&&t.confirmed()})},confirmed:function(){var e=$("#numeroItem"),t=e.val();d.removeItem(t),this.selector.modal("hide"),e.val("")}},o={selector:$("#modalConfirmacao"),show:function(e){$("#itens tbody tr").length;$("#message").text(e),this.selector.modal("show")},hide:function(){this.selector.modal("hide")}},d={addItemToTable:function(e){var t=$.Deferred(),o=parseInt($("#itens tbody tr").length)+1,a="<tr data-item="+btoa(JSON.stringify(e))+'><td class="text-center">'+o+"</td><td>"+e.response.codigoBarra+'</td><td class="col-sm-6">'+this.formatDescription(e.response.descricao,e.quantidade,e.response.medida)+"</td><td>R$ "+e.response.valorUnitario.toLocaleString()+"</td><td>R$ "+e.totalItem.toLocaleString()+"</td></tr>";$("#itens").append(a);var n=parseInt($("#itens tbody").height());return $(".dataTables_scrollBody").scrollTop(n),t.resolve(),t},removeItem:function(e){if(e--,0==$("#itens tbody tr").length)return $("#messageAlert").removeClass("hide"),setTimeout(function(){$("#messageAlert").addClass("hide")},5e3),!1;$("#itens tbody tr:eq("+e+")").remove(),d.calculaValorCompra(),d.reindexItens(),d.setTotalItens()},formatDescription:function(e,t,o){return e+"&emsp;&emsp;&emsp;&emsp;"+t+" x "+o},calculaValorCompra:function(){var a=0;$("#itens tbody tr").each(function(e,t){var o=JSON.parse(atob($(t).attr("data-item")));a+=o.totalItem}),$("#spanValorTotal").text(a.toLocaleString())},reindexItens:function(){var o=1;$("#itens tbody tr").each(function(e,t){$(t).children("td:eq(0)").text(o),o++})},setTotalItens:function(){$(".dataTables_scrollFootInner").find("td[colspan=2]").text(parseInt($("#itens tbody tr").length))}};$(function(){$("#insertHeader").load("../../fragmentos/menu-navegacao.html"),$("#navbar-theme").addClass("hide");$("#itens").DataTable({paging:!1,ordering:!1,info:!1,searching:!1,scrollY:"200px",scrollCollapse:!0});$("#itens tbody").empty(),$("#hideMenu").on("click",function(){$(this).hasClass("selected")?($(this).removeClass("selected"),$("#navbar-theme").removeClass("hide")):($(this).addClass("selected"),$("#navbar-theme").addClass("hide"))});var e=new r.Registry;e.add(r.Shorcut.F6,function(){$("#buscaProduto").focus().select()}),e.add(r.Shorcut.F8,function(){o.show("Você irá remover o item 22 da compra, deseja prosseguir?")}),t.listenEvent(),e.add(r.Shorcut.F9,function(){t.show()}),$("#modalRemoveItemByIndex").on("shown.bs.modal",function(){$("#numeroItem").focus()}),e.add(r.Shorcut.F10,function(){$("#itens tbody").empty(),d.calculaValorCompra(),d.setTotalItens()}),$("#buscaProduto").on("keyup",function(e){if(e.keyCode==r.Shorcut.ENTER){var t=$(this).val(),o=0,a=1;1==t.indexOf("*")?(o=parseInt(t.split("*")[1]),a=parseInt(t.split("*")[0])):o=parseInt(t),new n.WebClient(s["pdv.pesquisa.produto"]+"?codigoBarra="+o,"GET").call().done(function(e){e[0].quantidade=a;var t=i(e[0]);$.when(d.addItemToTable(t)).then(d.calculaValorCompra()),d.setTotalItens()}).fail(function(e){alert("erro")})}})})});